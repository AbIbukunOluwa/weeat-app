<%- include('partials/header', { title: title, user: user }) %>

<div class="vulns-container">
  <div class="vulns-header">
    <h1>üîí WeEat Security Testing Challenge</h1>
    <p class="tagline">Black Box Penetration Testing Environment</p>
    <p class="challenge-description">
      This is a deliberately vulnerable web application designed for security testing and education.
      Your goal is to find and exploit vulnerabilities to generate unique flags.
    </p>
  </div>

  <% if (message) { %>
    <div class="alert success">
      <i class="fas fa-check-circle"></i>
      <%= message %>
    </div>
  <% } %>
  <% if (error) { %>
    <div class="alert error">
      <i class="fas fa-exclamation-triangle"></i>
      <%= error %>
    </div>
  <% } %>

  <!-- Stats Section -->
  <div class="stats-section">
    <div class="stat-card">
      <div class="stat-icon">üéØ</div>
      <span class="stat-number"><%= totalVulns %></span>
      <span class="stat-label">Total Challenges</span>
    </div>
    <div class="stat-card success">
      <div class="stat-icon">‚úÖ</div>
      <span class="stat-number"><%= foundCount %></span>
      <span class="stat-label">Found</span>
    </div>
    <div class="stat-card warning">
      <div class="stat-icon">üîç</div>
      <span class="stat-number"><%= remainingCount %></span>
      <span class="stat-label">Remaining</span>
    </div>
    <div class="stat-card progress">
      <div class="stat-icon">üìä</div>
      <span class="stat-number"><%= progress %>%</span>
      <span class="stat-label">Progress</span>
    </div>
  </div>

  <!-- Progress Bar -->
  <div class="progress-container">
    <div class="progress-bar">
      <div class="progress-fill" style="width: <%= progress %>%">
        <span class="progress-text-inner"><%= progress %>%</span>
      </div>
    </div>
    <p class="progress-text">
      <%= foundCount %> of <%= totalVulns %> vulnerabilities discovered
      <% if (progress === 100) { %>
        üéâ <strong>Challenge Complete!</strong>
      <% } else if (progress >= 75) { %>
        üî• <strong>Almost there!</strong>
      <% } else if (progress >= 50) { %>
        üí™ <strong>Halfway done!</strong>
      <% } else if (progress >= 25) { %>
        üöÄ <strong>Good progress!</strong>
      <% } %>
    </p>
  </div>

  <!-- Submit Flag Form -->
  <div class="submit-section">
    <h2>üèÅ Submit Flag</h2>
    <p>Found a vulnerability? Submit your flag here to claim your discovery!</p>
    <form action="/vulns/submit" method="POST" class="flag-form">
      <div class="input-group">
        <input 
          type="text" 
          name="code" 
          placeholder="WeEat{...}" 
          pattern="^WeEat\{[A-Z0-9_]+\}$"
          title="Flag format: WeEat{UPPERCASE_ALPHANUMERIC_UNDERSCORE}"
          required
          autocomplete="off"
          spellcheck="false"
          class="flag-input"
        >
        <button type="submit" class="submit-btn">
          <i class="fas fa-paper-plane"></i>
          Submit Flag
        </button>
      </div>
      <small class="format-hint">
        Flags follow the format: <code>WeEat{TYPE_IDENTIFIER_HASH}</code>
      </small>
    </form>
  </div>

  <% if (foundCount > 0) { %>
  <!-- Found Vulnerabilities -->
  <div class="found-section">
    <h2>üèÜ Discovered Vulnerabilities</h2>
    <div class="vulnerability-grid">
      <% foundVulnerabilities.forEach(function(vuln, index) { %>
        <div class="vulnerability-card">
          <div class="vuln-number">#<%= index + 1 %></div>
          <h3><%= vuln.title %></h3>
          <div class="vuln-flag">
            <code><%= vuln.flag.substring(0, 15) %>...</code>
          </div>
          <div class="vuln-date">
            <i class="fas fa-clock"></i>
            <%= new Date(vuln.resolvedAt).toLocaleDateString() %>
          </div>
        </div>
      <% }); %>
    </div>
  </div>
  <% } %>

  <!-- Challenge Info -->
  <div class="challenge-info">
    <h2>üìã Challenge Guidelines</h2>
    <div class="rules-grid">
      <div class="rule-card">
        <div class="rule-icon">üéØ</div>
        <h3>Objective</h3>
        <p>Find and exploit vulnerabilities in the WeEat application. Each successful exploitation generates a unique flag that proves your discovery.</p>
      </div>
      <div class="rule-card">
        <div class="rule-icon">üîç</div>
        <h3>Methodology</h3>
        <p>This is a black box challenge. No hints, no vulnerability list. Use your penetration testing skills to discover and exploit security flaws.</p>
      </div>
      <div class="rule-card">
        <div class="rule-icon">üö´</div>
        <h3>Restrictions</h3>
        <p>Do not use automated scanners. Do not perform DoS attacks. Focus on manual exploitation techniques and creativity.</p>
      </div>
      <div class="rule-card">
        <div class="rule-icon">üèÜ</div>
        <h3>Scoring</h3>
        <p>Each valid flag represents a unique vulnerability. Flags are generated dynamically upon successful exploitation - no guessing!</p>
      </div>
    </div>
  </div>

  <!-- Methodology Hints Section -->
  <div class="methodology-section">
    <h2>üß≠ Getting Started</h2>
    <p>New to web application security testing? Here are some general areas to explore:</p>
    
    <div class="methodology-grid">
      <div class="method-card">
        <div class="method-icon">üìù</div>
        <h4>Input Validation</h4>
        <ul>
          <li>Test all input fields and parameters</li>
          <li>Try special characters and payloads</li>
          <li>Check form submissions and API endpoints</li>
        </ul>
      </div>
      
      <div class="method-card">
        <div class="method-icon">üîê</div>
        <h4>Authentication & Authorization</h4>
        <ul>
          <li>Test login mechanisms</li>
          <li>Check for privilege escalation</li>
          <li>Examine session management</li>
        </ul>
      </div>
      
      <div class="method-card">
        <div class="method-icon">üìÅ</div>
        <h4>File Handling</h4>
        <ul>
          <li>Test file upload functionality</li>
          <li>Check for path traversal</li>
          <li>Examine file access controls</li>
        </ul>
      </div>
      
      <div class="method-card">
        <div class="method-icon">üåê</div>
        <h4>Web Fundamentals</h4>
        <ul>
          <li>Analyze client-side code</li>
          <li>Test HTTP methods and headers</li>
          <li>Check for information disclosure</li>
        </ul>
      </div>
    </div>
    
    <div class="methodology-tips">
      <h4>üí° Pro Tips</h4>
      <div class="tips-grid">
        <div class="tip">Use browser developer tools to inspect requests and responses</div>
        <div class="tip">Try different HTTP methods (GET, POST, PUT, DELETE, etc.)</div>
        <div class="tip">Test with various user roles and permissions</div>
        <div class="tip">Look for hidden endpoints and parameters</div>
        <div class="tip">Check error messages for information leakage</div>
        <div class="tip">Test business logic flows thoroughly</div>
      </div>
    </div>
  </div>

  <!-- Application Areas -->
  <div class="areas-section">
    <h2>üó∫Ô∏è Application Areas to Explore</h2>
    <div class="areas-grid">
      <a href="/menu" class="area-card">
        <div class="area-icon">üçï</div>
        <h4>Menu System</h4>
        <p>Food browsing, search, and ordering</p>
      </a>
      
      <a href="/auth/login" class="area-card">
        <div class="area-icon">üë§</div>
        <h4>Authentication</h4>
        <p>Login, registration, and user management</p>
      </a>
      
      <a href="/orders" class="area-card">
        <div class="area-icon">üì¶</div>
        <h4>Order Management</h4>
        <p>Order creation, tracking, and history</p>
      </a>
      
      <a href="/reviews" class="area-card">
        <div class="area-icon">‚≠ê</div>
        <h4>Reviews & Feedback</h4>
        <p>User reviews and complaint system</p>
      </a>
      
      <a href="/profile" class="area-card">
        <div class="area-icon">‚öôÔ∏è</div>
        <h4>User Profiles</h4>
        <p>Profile management and file uploads</p>
      </a>
      
      <% if (user && user.role === 'admin') { %>
      <a href="/admin" class="area-card admin">
        <div class="area-icon">üîß</div>
        <h4>Admin Panel</h4>
        <p>Administrative functions and reporting</p>
      </a>
      <% } %>
    </div>
  </div>

  <div class="disclaimer-section">
    <div class="disclaimer">
      <h4>‚ö†Ô∏è Educational Purpose Disclaimer</h4>
      <p>
        This application contains <strong>intentional security vulnerabilities</strong> for educational purposes only. 
        All vulnerabilities are designed to be exploitable in a controlled environment. 
        <strong>Do not apply these techniques to systems you do not own or have explicit permission to test.</strong>
      </p>
      <p>
        <strong>Remember:</strong> Ethical hacking requires proper authorization. Always get written permission before testing real systems.
      </p>
    </div>
  </div>

  <% if (user && user.role === 'admin') { %>
  <!-- Admin Controls -->
  <div class="admin-section">
    <h3>üîß Admin Controls</h3>
    <div class="admin-actions">
      <form action="/vulns/reset" method="POST" onsubmit="return confirm('‚ö†Ô∏è This will reset ALL progress and delete all flags. Are you sure?')" class="inline-form">
        <button type="submit" class="btn-reset">
          <i class="fas fa-refresh"></i>
          Reset All Progress
        </button>
      </form>
      
      <a href="/vulns/api/export" class="btn-export">
        <i class="fas fa-download"></i>
        Export Results
      </a>
      
      <a href="/vulns/api/stats" class="btn-stats" target="_blank">
        <i class="fas fa-chart-bar"></i>
        View Statistics
      </a>
    </div>
  </div>
  <% } %>
</div>

<style>
:root {
  --primary-red: #dc2626;
  --accent-yellow: #fbbf24;
  --success-green: #10b981;
  --warning-orange: #f59e0b;
  --dark-bg: #1f2937;
  --card-bg: #ffffff;
  --text-primary: #111827;
  --text-secondary: #6b7280;
  --border-color: #e5e7eb;
  --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
  --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
}

.vulns-container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 30px 20px;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}

.vulns-header {
  text-align: center;
  margin-bottom: 40px;
}

.vulns-header h1 {
  color: var(--primary-red);
  font-size: 2.5em;
  font-weight: 700;
  margin-bottom: 10px;
  text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
}

.tagline {
  color: var(--text-secondary);
  font-size: 1.3em;
  font-weight: 500;
  margin-bottom: 15px;
}

.challenge-description {
  max-width: 800px;
  margin: 0 auto;
  color: var(--text-primary);
  font-size: 1.1em;
  line-height: 1.6;
}

.alert {
  padding: 16px 20px;
  border-radius: 12px;
  margin-bottom: 25px;
  font-weight: 600;
  text-align: center;
  animation: slideIn 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
}

@keyframes slideIn {
  from { transform: translateY(-20px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

.alert.success {
  background: #d1fae5;
  color: #065f46;
  border: 2px solid #10b981;
}

.alert.error {
  background: #fee2e2;
  color: #991b1b;
  border: 2px solid #dc2626;
}

.stats-section {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: 25px;
  margin-bottom: 35px;
}

.stat-card {
  background: var(--card-bg);
  padding: 30px 25px;
  border-radius: 16px;
  text-align: center;
  box-shadow: var(--shadow);
  transition: all 0.3s ease;
  border: 2px solid transparent;
  position: relative;
  overflow: hidden;
}

.stat-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: var(--primary-red);
}

.stat-card.success::before { background: var(--success-green); }
.stat-card.warning::before { background: var(--warning-orange); }
.stat-card.progress::before { background: var(--accent-yellow); }

.stat-card:hover {
  transform: translateY(-5px);
  box-shadow: var(--shadow-lg);
}

.stat-icon {
  font-size: 2em;
  margin-bottom: 10px;
  display: block;
}

.stat-number {
  display: block;
  font-size: 2.8em;
  font-weight: 800;
  color: var(--primary-red);
  margin: 10px 0 5px 0;
  line-height: 1;
}

.stat-card.success .stat-number { color: var(--success-green); }
.stat-card.warning .stat-number { color: var(--warning-orange); }
.stat-card.progress .stat-number { color: var(--accent-yellow); }

.stat-label {
  color: var(--text-secondary);
  font-size: 0.95em;
  text-transform: uppercase;
  letter-spacing: 1px;
  font-weight: 600;
}

.progress-container {
  margin-bottom: 40px;
}

.progress-bar {
  width: 100%;
  height: 40px;
  background: #f3f4f6;
  border-radius: 20px;
  overflow: hidden;
  box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
  position: relative;
}

.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--primary-red), var(--accent-yellow));
  transition: width 0.8s ease;
  display: flex;
  align-items: center;
  justify-content: flex-end;
  padding-right: 15px;
  position: relative;
}

.progress-text-inner {
  color: white;
  font-weight: 700;
  text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
}

.progress-text {
  text-align: center;
  margin-top: 15px;
  color: var(--text-primary);
  font-size: 1.1em;
  font-weight: 500;
}

.submit-section {
  background: var(--card-bg);
  padding: 35px;
  border-radius: 16px;
  margin-bottom: 40px;
  box-shadow: var(--shadow);
  text-align: center;
  border: 2px solid var(--border-color);
}

.submit-section h2 {
  color: var(--primary-red);
  margin-bottom: 10px;
  font-size: 1.8em;
}

.submit-section p {
  color: var(--text-secondary);
  margin-bottom: 25px;
  font-size: 1.1em;
}

.flag-form .input-group {
  display: flex;
  gap: 15px;
  max-width: 600px;
  margin: 0 auto 10px auto;
}

.flag-input {
  flex: 1;
  padding: 15px 20px;
  border: 2px solid var(--border-color);
  border-radius: 12px;
  font-size: 16px;
  font-family: 'Courier New', monospace;
  text-transform: uppercase;
  transition: all 0.3s;
  background: #f9fafb;
}

.flag-input:focus {
  outline: none;
  border-color: var(--accent-yellow);
  background: white;
  box-shadow: 0 0 0 3px rgba(251, 191, 36, 0.1);
}

.flag-input:valid {
  border-color: var(--success-green);
}

.submit-btn {
  padding: 15px 30px;
  background: var(--primary-red);
  color: white;
  border: none;
  border-radius: 12px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s;
  display: flex;
  align-items: center;
  gap: 10px;
  white-space: nowrap;
}

.submit-btn:hover {
  background: #b91c1c;
  transform: translateY(-2px);
  box-shadow: var(--shadow-lg);
}

.format-hint {
  color: var(--text-secondary);
  font-size: 0.9em;
}

.format-hint code {
  background: #f3f4f6;
  padding: 2px 6px;
  border-radius: 4px;
  font-size: 0.85em;
}

.found-section {
  margin-bottom: 40px;
}

.found-section h2 {
  color: var(--primary-red);
  margin-bottom: 25px;
  text-align: center;
}

.vulnerability-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  gap: 20px;
}

.vulnerability-card {
  background: var(--card-bg);
  padding: 25px;
  border-radius: 12px;
  box-shadow: var(--shadow);
  border-left: 4px solid var(--success-green);
  transition: all 0.3s;
}

.vulnerability-card:hover {
  transform: translateY(-3px);
  box-shadow: var(--shadow-lg);
}

.vuln-number {
  background: var(--success-green);
  color: white;
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 0.8em;
  font-weight: 700;
  display: inline-block;
  margin-bottom: 10px;
}

.vulnerability-card h3 {
  color: var(--text-primary);
  margin-bottom: 10px;
  font-size: 1.2em;
}

.vuln-flag {
  margin-bottom: 10px;
}

.vuln-flag code {
  background: #f3f4f6;
  padding: 8px 12px;
  border-radius: 6px;
  color: var(--primary-red);
  font-weight: 600;
  font-size: 0.9em;
}

.vuln-date {
  color: var(--text-secondary);
  font-size: 0.9em;
  display: flex;
  align-items: center;
  gap: 6px;
}

.challenge-info, .methodology-section, .areas-section {
  margin-bottom: 40px;
}

.challenge-info h2, .methodology-section h2, .areas-section h2 {
  color: var(--primary-red);
  margin-bottom: 25px;
  text-align: center;
  font-size: 1.8em;
}

.rules-grid, .methodology-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 25px;
}

.rule-card, .method-card {
  background: var(--card-bg);
  padding: 25px;
  border-radius: 12px;
  box-shadow: var(--shadow);
  transition: all 0.3s;
}

.rule-card:hover, .method-card:hover {
  transform: translateY(-3px);
  box-shadow: var(--shadow-lg);
}

.rule-icon, .method-icon {
  font-size: 2.5em;
  margin-bottom: 15px;
  display: block;
}

.rule-card h3, .method-card h4 {
  color: var(--text-primary);
  margin-bottom: 10px;
  font-size: 1.3em;
}

.rule-card p, .method-card ul {
  color: var(--text-secondary);
  line-height: 1.6;
}

.method-card ul {
  list-style: none;
  padding: 0;
}

.method-card li {
  padding: 6px 0;
  padding-left: 20px;
  position: relative;
}

.method-card li::before {
  content: '‚Üí';
  position: absolute;
  left: 0;
  color: var(--accent-yellow);
  font-weight: bold;
}

.methodology-tips {
  margin-top: 30px;
  text-align: center;
}

.methodology-tips h4 {
  color: var(--primary-red);
  margin-bottom: 20px;
}

.tips-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 15px;
}

.tip {
  background: #fef3c7;
  color: #92400e;
  padding: 12px 16px;
  border-radius: 8px;
  font-size: 0.9em;
  border-left: 3px solid var(--warning-orange);
}

.areas-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 20px;
}

.area-card {
  background: var(--card-bg);
  padding: 25px;
  border-radius: 12px;
  box-shadow: var(--shadow);
  text-decoration: none;
  color: inherit;
  transition: all 0.3s;
  text-align: center;
  border: 2px solid transparent;
}

.area-card:hover {
  transform: translateY(-5px);
  box-shadow: var(--shadow-lg);
  border-color: var(--primary-red);
  text-decoration: none;
  color: inherit;
}

.area-card.admin {
  border-color: var(--warning-orange);
}

.area-card.admin:hover {
  border-color: var(--warning-orange);
  background: #fffbeb;
}

.area-icon {
  font-size: 2.5em;
  margin-bottom: 15px;
  display: block;
}

.area-card h4 {
  color: var(--text-primary);
  margin-bottom: 8px;
  font-size: 1.2em;
}

.area-card p {
  color: var(--text-secondary);
  font-size: 0.95em;
  margin: 0;
}

.disclaimer-section {
  margin-bottom: 40px;
}

.disclaimer {
  background: #fef2f2;
  border: 2px solid #fecaca;
  border-radius: 12px;
  padding: 25px;
  color: #991b1b;
}

.disclaimer h4 {
  margin-bottom: 15px;
  color: #dc2626;
}

.disclaimer p {
  margin-bottom: 10px;
  line-height: 1.6;
}

.admin-section {
  background: #f8f9fa;
  border: 2px solid #e9ecef;
  border-radius: 12px;
  padding: 25px;
  text-align: center;
  margin-top: 40px;
}

.admin-section h3 {
  color: var(--text-primary);
  margin-bottom: 20px;
}

.admin-actions {
  display: flex;
  justify-content: center;
  gap: 15px;
  flex-wrap: wrap;
}

.btn-reset, .btn-export, .btn-stats {
  padding: 12px 20px;
  border: none;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
  text-decoration: none;
  display: inline-flex;
  align-items: center;
  gap: 8px;
}

.btn-reset {
  background: #dc2626;
  color: white;
}

.btn-reset:hover {
  background: #b91c1c;
}

.btn-export {
  background: var(--success-green);
  color: white;
}

.btn-export:hover {
  background: #059669;
  text-decoration: none;
  color: white;
}

.btn-stats {
  background: #3b82f6;
  color: white;
}

.btn-stats:hover {
  background: #2563eb;
  text-decoration: none;
  color: white;
}

.inline-form {
  display: inline;
}

@media (max-width: 768px) {
  .vulns-container {
    padding: 20px 15px;
  }
  
  .vulns-header h1 {
    font-size: 2em;
  }
  
  .flag-form .input-group {
    flex-direction: column;
  }
  
  .stats-section {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .rules-grid, .methodology-grid {
    grid-template-columns: 1fr;
  }
  
  .areas-grid {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .admin-actions {
    flex-direction: column;
    align-items: center;
  }
}

@media (max-width: 480px) {
  .stats-section {
    grid-template-columns: 1fr;
  }
  
  .areas-grid {
    grid-template-columns: 1fr;
  }
}
</style>

<script>
// Real-time progress updates
function updateProgress() {
  fetch('/vulns/api/stats')
    .then(response => response.json())
    .then(data => {
      if (data.found !== <%= foundCount %>) {
        location.reload();
      }
    })
    .catch(error => console.log('Progress check failed:', error));
}

// Check for updates every 30 seconds
setInterval(updateProgress, 30000);

// Flag input formatting
document.querySelector('.flag-input').addEventListener('input', function(e) {
  this.value = this.value.toUpperCase();
});

// Form submission feedback
document.querySelector('.flag-form').addEventListener('submit', function(e) {
  const submitBtn = this.querySelector('.submit-btn');
  const originalText = submitBtn.innerHTML;
  
  submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Validating...';
  submitBtn.disabled = true;
  
  // Re-enable after 3 seconds in case of slow response
  setTimeout(() => {
    submitBtn.innerHTML = originalText;
    submitBtn.disabled = false;
  }, 3000);
});

// Easter egg: Konami code for extra hint
let konamiCode = [];
const konamiSequence = [38, 38, 40, 40, 37, 39, 37, 39, 66, 65];

document.addEventListener('keydown', function(e) {
  konamiCode.push(e.keyCode);
  if (konamiCode.length > konamiSequence.length) {
    konamiCode.shift();
  }
  
  if (JSON.stringify(konamiCode) === JSON.stringify(konamiSequence)) {
    console.log('üéÆ Konami Code activated! Extra tip: Check HTTP headers and methods thoroughly!');
    konamiCode = [];
  }
});

console.log('üîç WeEat Security Challenge Loaded');
console.log('üí° Tip: Use browser dev tools to inspect requests and responses');
console.log('üéØ Your goal: Find vulnerabilities and collect flags');
</script>

<%- include('partials/footer') %>
